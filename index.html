<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>æ‹¼éŸ³å¤§å†’é™© - Dollyçš„æ‹¼éŸ³å­¦ä¹ æ¸¸æˆ</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    /* åŠ è½½åŠ¨ç”» */
    #loading {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: linear-gradient(135deg, #ff69b4, #ff85c8);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: white;
      z-index: 9999;
      transition: opacity 0.5s;
    }
    #loading.hidden { opacity: 0; pointer-events: none; }
    #loading .loading-heart {
      font-size: 80px;
      animation: pulse 1s infinite;
    }
    #loading h1 { font-size: 36px; margin-top: 20px; }
    #loading p { font-size: 16px; opacity: 0.8; margin-top: 10px; }
  </style>
</head>
<body>
  <!-- åŠ è½½ç”»é¢ -->
  <div id="loading">
    <div class="loading-heart">ğŸ©·</div>
    <h1>æ‹¼éŸ³å¤§å†’é™©</h1>
    <p>æ­£åœ¨å‡†å¤‡å†’é™©...</p>
  </div>

  <!-- åº”ç”¨å®¹å™¨ -->
  <div id="app"></div>

  <!-- æŒ‰é¡ºåºåŠ è½½è„šæœ¬ -->
  <script src="sherpa/sherpa-onnx-asr.js"></script>
  <script src="sherpa/sherpa-onnx-vad.js"></script>
  <script src="js/pinyin-data.js"></script>
  <script src="js/data.js"></script>
  <script src="js/mastery.js"></script>
  <script src="js/error-book.js"></script>
  <script src="js/speech.js?v=6"></script>
  <script src="js/game.js?v=5"></script>
  <script src="js/app.js?v=5"></script>
  <script>
    // é¡µé¢åŠ è½½ï¼šåŠ è½½ sherpa-onnx è¯­éŸ³æ¨¡å‹ï¼Œå†éšè—åŠ è½½ç”»é¢
    window.addEventListener('load', async () => {
      const loadingText = document.querySelector('#loading p');

      // é¢„åŠ è½½ sherpa-onnx è¯­éŸ³æ¨¡å‹ï¼ˆ~94MB WASM+dataï¼Œé¦–æ¬¡ä¸‹è½½åæµè§ˆå™¨ç¼“å­˜ï¼‰
      if (SpeechModule.isSupported) {
        const ok = await SpeechModule.loadModel((status) => {
          if (!status) return;
          // è§£æ Emscripten ä¸‹è½½è¿›åº¦
          const match = status.match(/Downloading data\.\.\. \((\d+)\/(\d+)\)/);
          if (match) {
            const pct = (Number(match[1]) / Number(match[2]) * 100).toFixed(1);
            if (loadingText) loadingText.textContent = `æ­£åœ¨ä¸‹è½½è¯­éŸ³æ¨¡å‹... ${pct}%`;
          } else if (status.includes('Running')) {
            if (loadingText) loadingText.textContent = 'æ­£åœ¨åˆå§‹åŒ–è¯­éŸ³å¼•æ“...';
          } else {
            if (loadingText) loadingText.textContent = 'æ­£åœ¨åŠ è½½è¯­éŸ³æ¨¡å‹...';
          }
        });
        if (ok) {
          App._sherpaModelReady = true;
          console.log('[Init] sherpa-onnx æ¨¡å‹åŠ è½½å®Œæˆ');
        } else {
          console.warn('[Init] sherpa-onnx æ¨¡å‹åŠ è½½å¤±è´¥ï¼Œè¯­éŸ³åŠŸèƒ½ä¸å¯ç”¨');
        }
      }

      if (loadingText) loadingText.textContent = 'å‡†å¤‡å®Œæ¯•!';
      setTimeout(() => {
        document.getElementById('loading').classList.add('hidden');
        setTimeout(() => document.getElementById('loading').remove(), 500);
      }, 300);
    });
  </script>
</body>
</html>
